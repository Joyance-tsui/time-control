<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间管理助手</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
             display: flex;
             width: 100vw;
             height: 70vh;
             max-width: 1800px;
             padding: 2vh;
             box-sizing: border-box;
             margin-top: 20px;
             align-items: center;
            justify-content: center;
        }
        .left-panel {
           flex: 0.618;
             padding: 10px;
           box-sizing: border-box;
            display: flex;
            flex-direction: column;
       }
        .right-panel {
            flex: 0.382;
             padding: 10px;
           box-sizing: border-box;
        }
        #top-time-bar {
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            display: flex;
           align-items: center;
            justify-content: space-between;
        }
        #current-time {
           font-size: 2.5vw;
            font-weight: bold;
            display: flex;
           align-items: baseline;
           white-space: nowrap;
        }
        #sleep-time-display {
             opacity: 0.5;
            font-size: 1vw;
           color: #999;
           margin-left: 0.5vw;
             white-space: nowrap;
        }
        #day-progress-container {
              height: 2vh;
            margin: 0 1vw;
             cursor: pointer;
            position: relative;
             overflow: hidden;
           background-color: #ddd;
           border-radius: 0.5vh;
        }
        #day-progress {
            height: 100%;
            background-color: #aaa;
            width: 0%;
            transition: width 0.3s ease-in-out;
        }
         #sleep-time-indicator {
           position: absolute;
            top: -1vh;
           height: 2vh;
             width: 0.2vh;
             background-color: #888;
             pointer-events: auto;
             cursor: grab;
        }
        #sleep-time-indicator:active {
            cursor: grabbing;
       }
        #schedule-container {
            position: absolute;
            top: 100%;
            left: 0;
             right: 0;
             height: 4vh;
            margin-top: 0.5vh;
            display: flex;
            align-items: center;
            pointer-events: none;
        }
         .schedule-item {
           background-color: #bbb;
            color: #fff;
            padding: 0.8vh 1.2vh;
           border-radius: 0.5vh;
           margin-right: 0.5vh;
             font-size: 0.9vw;
            position: absolute;
             top: 0;
            height: 100%;
            display: flex;
            align-items: center;
             justify-content: center;
            box-shadow: 0 0.1vh 0.3vh rgba(0, 0, 0, 0.2);
       }
        .schedule-item.late {
             background-color: #999;
        }
        #sleep-time-settings {
           position: absolute;
            top: 3vh;
             left: 0;
            right: 0;
            padding: 1.5vh;
            display: flex;
           flex-direction: column;
            align-items: center;
             gap: 1vh;
             z-index: 10;
        }
        #sleep-time-tooltip {
           background-color: rgba(0, 0, 0, 0.8);
             color: white;
            padding: 0.5vh 1vh;
            border-radius: 0.5vh;
            font-size: 0.9vw;
            position: absolute;
           top: -3vh;
             left: 50%;
             transform: translateX(-50%);
           white-space: nowrap;
        }
       .time-controls {
            display: flex;
             gap: 1vh;
             align-items: center;
       }
       .time-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .time-spinner label {
            font-size: 0.8vw;
           margin-bottom: 0.5vh;
       }
       .time-spinner input[type="number"] {
             width: 5vh;
            padding: 0.5vh;
            border: 1px solid #ccc;
            text-align: center;
       }
         #focus-timer {
            padding: 2.5vh;
            display: flex;
            flex-direction: column;
             align-items: center;
            background-color: rgba(200, 200, 200, 0.1);
            border-radius: 0.5vh;
            box-sizing: border-box;
             position: relative;
        }
       #focus-settings-summary {
            display: flex;
            gap: 2vh;
            margin-bottom: 1.5vh;
             cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        #focus-settings-summary.locked {
           cursor: not-allowed;
             pointer-events: none;
            opacity: 0.7;
        }
        .setting-label {
             font-weight: bold;
        }
        #focus-settings-detailed {
            display: none;
             flex-direction: column;
             align-items: center;
             gap: 1.5vh;
           width: 100%;
        }
        .duration-control {
           display: flex;
           align-items: center;
           gap: 1vh;
        }
         .duration-control input[type="number"] {
             width: 5vh;
        }
       #info-bar {
           background-color: rgba(200, 200, 200, 0.2);
            text-align: center;
            padding: 1vh;
            margin-bottom: 1.5vh;
             border-radius: 0.5vh;
        }
         #timer-display {
            text-align: center;
            font-size: 4vw;
            font-weight: bold;
            margin-bottom: 2vh;
         }
         #progress-bar-container {
             height: 3vh;
             margin-bottom: 2vh;
            overflow: hidden;
            width: 100%;
            position: relative;
        }
       #progress-bar {
             background-color: #666;
             height: 100%;
             width: 0%;
            transition: width 0.3s ease-out, right 0.3s ease-out, background-color 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            color: white;
            font-size: 1vw;
             white-space: nowrap;
             padding: 0 1vw;
            box-sizing: border-box;
           position: absolute;
           left: 0;
        }
        #progress-bar.overtime {
            background-color: #aa6666;
             justify-content: flex-end;
             left: auto;
            right: 0;
         }
         #start-stop-button {
            padding: 1vh 2vh;
             border: none;
             color: #333;
             border-radius: 0.5vh;
             cursor: pointer;
             font-size: 1.2vw;
            transition: background-color 0.3s ease;
            margin-bottom: 1vh;
            white-space: nowrap;
        }
        #start-stop-button.running {
             background-color: #555;
        }
         .controls-container {
           display: flex;
             gap: 1vh;
       }
        .controls-container button {
            padding: 1vh 2vh;
             border: none;
            border-radius: 0.5vh;
             cursor: pointer;
           font-size: 1.1vw;
            white-space: nowrap;
            color: #333;
        }
       #pause-button {
            background-color: #bbb;
             color: #333;
        }
       #pause-button:hover {
           background-color: #999;
            color: white;
        }
        #clear-button {
            color: #333;
           background-color: #ddd;
       }
       #clear-button:hover {
            color: white;
           background-color: #ccc;
        }
        .time-node-draggable {
             position: absolute;
           top: 0;
           left: 0;
             cursor: grab;
            z-index: 10;
             display: flex;
            white-space: nowrap;
            padding: 0 0.5vw;
       }
        .time-node-draggable:active {
            cursor: grabbing;
        }
       #schedule-section {
           width: 100%;
            max-height: 60vh;
            overflow-y: auto;
             margin-top: 1vh;
            background-color: rgba(200, 200, 200, 0.1);
            border-radius: 0.5vh;
           padding: 1vh;
        }
        #schedule-section h3 {
            font-size: 1.3vw;
           margin-bottom: 0.5vh;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .time-node-item {
           padding: 0.5vh 1vh;
           margin-bottom: 0.5vh;
            border-bottom: 1px solid #eee;
             font-size: 1vw;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            cursor: pointer;
       }
        .time-node-item:hover .time-node-time{
            background-color: #ddd;
        }
         .time-node-item .time-node-time {
            padding: 0.3vh 0.5vw;
            border-radius: 0.2vw;
              transition: background-color 0.3s ease;
        }
        .time-node-item.editing .time-node-time {
            background-color: #bbb;
        }
        .time-node-item .time-node-detail {
            display: flex;
             flex-direction: column;
             padding-right: 2vw;
       }
        .time-node-item .reminder-time {
            font-size: 0.8vw;
             color: #777;
        }
        #add-time-node-drawer {
            position: absolute;
            top: 0;
           left: 0;
             right: 0;
            bottom: 0;
            padding: 2vw;
            background-color: rgba(255, 255, 255, 0.95);
             z-index: 100;
            display: flex;
             flex-direction: column;
            align-items: center;
            box-sizing: border-box;
            display: none;
       }
        #add-time-node-drawer.active {
             display: flex;
        }
       #add-time-node-drawer > h3 {
             font-size: 1.8vw;
        }
        #add-time-node-drawer label {
             font-size: 1.1vw;
             margin-top: 1vw;
             display: block;
        }
        #add-time-node-drawer input[type="text"], #add-time-node-drawer input[type="number"]{
              padding: 0.5vw;
              border: 1px solid #ccc;
             width: 100%;
            box-sizing: border-box;
         }
        #add-time-node-drawer button {
            padding: 1vh 2vh;
           border: none;
            border-radius: 0.5vh;
            cursor: pointer;
            font-size: 1.1vw;
            white-space: nowrap;
            color: #333;
            margin-top: 1.5vw;
         }
        #add-time-node-drawer button:hover {
             background-color: #ddd;
            color: #333;
        }
         #add-time-node-drawer #drawer-close-button {
            position: absolute;
            top: 1vw;
             right: 1vw;
            font-size: 2vw;
           cursor: pointer;
        }
       #reset-settings-button {
            margin-top: 1vw;
            background-color: #ddd;
             color: #333;
            padding: 1vh 2vh;
             border: none;
           border-radius: 0.5vh;
            cursor: pointer;
            font-size: 1vw;
             white-space: nowrap;
        }
       #reset-settings-button:hover {
            background-color: #ccc;
        }
         .hidden {
            display: none !important;
         }
         #schedule-date-display {
            font-size: 1vw;
           color: #777;
           white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div id="top-time-bar">
                <div id="current-time">
                   <span></span><div id="sleep-time-display"></div>
                 </div>
            </div>
             <div id="info-bar"></div>
            <div id="day-progress-container">
                <div id="day-progress"></div>
                 <div id="schedule-container"></div>
               <div id="sleep-time-settings" class="hidden">
                    <div id="sleep-time-tooltip" class="tooltip hidden"></div>
                    <div class="time-controls">
                        <div class="time-spinner">
                             <label for="sleep-hours">小时:</label>
                            <input type="number" id="sleep-hours" min="0" max="23">
                        </div>
                       <div class="time-spinner">
                             <label for="sleep-minutes">分钟:</label>
                            <input type="number" id="sleep-minutes" min="0" max="59">
                        </div>
                       <input type="text" id="sleep-time-input" placeholder="HH:MM">
                    </div>
                     <button id="sleep-time-confirm">确定</button>
                </div>
            </div>
           <div id="focus-timer">
                 <div id="focus-settings-summary">
                     <div class="setting-label">专注时长: <span id="focus-duration-display">25</span> 分钟</div>
                     <div class="setting-label">休息时长: <span id="break-duration-display">5</span> 分钟</div>
                </div>
               <div id="focus-settings-detailed">
                    <div class="duration-control">
                       <label for="focus-duration-slider">专注时长:</label>
                       <input type="range" id="focus-duration-slider" min="1" max="120" value="25" class="duration-slider">
                       <input type="number" id="focus-duration" min="1" max="120" value="25">
                   </div>
                   <div class="duration-control">
                        <label for="break-duration-slider">休息时长:</label>
                        <input type="range" id="break-duration-slider" min="1" max="60" value="5" class="duration-slider">
                        <input type="number" id="break-duration" min="1" max="60" value="5">
                    </div>
                    <div class="duration-control">
                       <label for="break-multiplier-slider">休息倍率:</label>
                       <input type="range" id="break-multiplier-slider" min="0.1" max="5" value="1" step="0.1" class="duration-slider">
                       <input type="number" id="break-multiplier" min="0.1" max="5" value="1" step="0.1">
                   </div>
                   <div class="duration-control">
                        <label for="transition-multiplier-slider">过渡倍率:</label>
                        <input type="range" id="transition-multiplier-slider" min="1" max="10" value="5" step="1" class="duration-slider">
                         <input type="number" id="transition-multiplier" min="1" max="10" value="5" step="1">
                    </div>
                    <div class="duration-control">
                       <label for="quadratic-a">系数a:</label>
                         <input type="number" id="quadratic-a"  value="0.01" step="0.01">
                    </div>
                    <div class="duration-control">
                        <label for="quadratic-b">系数b:</label>
                       <input type="number" id="quadratic-b"  value="0.1" step="0.1">
                    </div>
                    <div class="duration-control">
                       <label for="quadratic-c">系数c:</label>
                       <input type="number" id="quadratic-c" value="1" step="0.1">
                    </div>
                   <button id="reset-settings-button">重置设置</button>
                </div>
                 <div id="timer-display">00:00</div>
               <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                 </div>
                 <button id="start-stop-button">开始/折叠</button>
                 <div class="controls-container hidden">
                    <button id="pause-button">暂停</button>
                     <button id="clear-button">清空</button>
                    <button id="break-button">休息</button>
                 </div>
           </div>
         </div>
         <div class="right-panel">
            <div id="schedule-section">
                 <h3>
                     日历 <button id="add-time-node-button">+</button>
                   <div id="schedule-date-display"></div>
                 </h3>
             </div>
         </div>
    </div>
    <div id="add-time-node-drawer" class="hidden">
         <span id="drawer-close-button">×</span>
        <h3>添加时间节点</h3>
        <label for="node-name">节点名称:</label>
         <input type="text" id="node-name">
         <label for="reminder-time">提前提醒(分钟):</label>
         <input type="number" id="reminder-time" value="5">
        <button id="add-node-confirm">保存</button>
   </div>
     <script>
         document.addEventListener('DOMContentLoaded', () => {
             const currentTimeElement = document.querySelector('#current-time > span');
            const sleepTimeDisplay = document.getElementById('sleep-time-display');
            const dayProgressContainer = document.getElementById('day-progress-container');
           const dayProgress = document.getElementById('day-progress');
             const scheduleContainer = document.getElementById('schedule-container');
             const timerDisplay = document.getElementById('timer-display');
             const progressBar = document.getElementById('progress-bar');
           const startStopButton = document.getElementById('start-stop-button');
           const pauseButton = document.getElementById('pause-button');
            const clearButton = document.getElementById('clear-button');
            const controlsContainer = document.querySelector('.controls-container');
             const sleepTimeSettings = document.getElementById('sleep-time-settings');
            const sleepTimeTooltip = document.getElementById('sleep-time-tooltip');
             const sleepHoursInput = document.getElementById('sleep-hours');
            const sleepMinutesInput = document.getElementById('sleep-minutes');
            const sleepTimeInput = document.getElementById('sleep-time-input');
             const sleepTimeConfirmButton = document.getElementById('sleep-time-confirm');
            const focusTimerElement = document.getElementById('focus-timer');
              const focusSettingsSummary = document.getElementById('focus-settings-summary');
             const focusSettingsDetailed = document.getElementById('focus-settings-detailed');
            const focusDurationDisplay = document.getElementById('focus-duration-display');
            const breakDurationDisplay = document.getElementById('break-duration-display');
            const focusDurationInput = document.getElementById('focus-duration');
           const breakDurationInput = document.getElementById('break-duration');
            const focusDurationSlider = document.getElementById('focus-duration-slider');
           const breakDurationSlider = document.getElementById('break-duration-slider');
             const breakMultiplierInput = document.getElementById('break-multiplier');
            const breakMultiplierSlider = document.getElementById('break-multiplier-slider');
             const transitionMultiplierInput = document.getElementById('transition-multiplier');
            const transitionMultiplierSlider = document.getElementById('transition-multiplier-slider');
            const quadraticAInput = document.getElementById('quadratic-a');
             const quadraticBInput = document.getElementById('quadratic-b');
            const quadraticCInput = document.getElementById('quadratic-c');
            const infoBar = document.getElementById('info-bar');
             const addTimeNodeButton = document.getElementById('add-time-node-button');
             const addTimeNodeDrawer = document.getElementById('add-time-node-drawer');
            const drawerCloseButton = document.getElementById('drawer-close-button');
            const nodeNameInput = document.getElementById('node-name');
             const reminderTimeInput = document.getElementById('reminder-time');
             const addNodeConfirmButton = document.getElementById('add-node-confirm');
             const scheduleSection = document.getElementById('schedule-section');
            const resetSettingsButton = document.getElementById('reset-settings-button');
             const breakButton = document.getElementById('break-button');
              const scheduleDateDisplay = document.getElementById('schedule-date-display');
                let now;
           let timeNodes = JSON.parse(localStorage.getItem('timeNodes') || '[]');
            let isDraggingSleepTime = false;
             let dragStartX;
             let dragStartSleepMinutes;
             let isSettingNewNode = false;
             let newNodeTime = '';
             let isDraggingNode = false;
            let draggedNodeElement;
            let dragNodeStartX;
            let dragNodeStartY;
            let draggedNodeOriginalLeft;
              let draggedNodeOriginalTop;
            let editingNode = null;
             let focusInterval;
             let remainingTime;
            let isFocusing = false;
            let isPaused = false;
             let totalFocusTime;
             let focusStartTime;
             let pauseStartTime;
            let isOvertime = false;
            let breakInterval;
             let remainingBreakTime;
             let breakStartTime;
            let totalBreakTime;
           let baseBreakDuration;
           let breakTimeMultiplier = parseFloat(localStorage.getItem('breakTimeMultiplier')) || 1;
            let transitionMultiplier = parseInt(localStorage.getItem('transitionMultiplier')) || 5;
             let quadraticA = parseFloat(localStorage.getItem('quadraticA')) || 0.01;
             let quadraticB = parseFloat(localStorage.getItem('quadraticB')) || 0.1;
            let quadraticC = parseFloat(localStorage.getItem('quadraticC')) || 1;
            let settingsLocked = false;
             function updateCurrentTime() {
                 now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                 const minutes = String(now.getMinutes()).padStart(2, '0');
                 currentTimeElement.textContent = `${hours}:${minutes}`;
                 updateNodeDisplay();
                 const currentMinutes = now.getHours() * 60 + now.getMinutes();
                let minTimeDiff = Infinity;
                let closestNode = null;
                timeNodes.forEach(node => {
                   const nodeTimeMinutes = timeToMinutes(node.time);
                    let timeDiff = (nodeTimeMinutes - currentMinutes);
                   if (timeDiff > 0 && timeDiff < minTimeDiff) {
                         minTimeDiff = timeDiff;
                        closestNode = node;
                   }
               });
                if (closestNode && minTimeDiff <= parseInt(closestNode.reminder)) {
                    infoBar.textContent = `${closestNode.name} 即将到达`;
                }else {
                  infoBar.textContent = '';
                }
            }
            function updateDayProgress() {
                const minutesInDay = 24 * 60;
                 const currentMinutes = now.getHours() * 60 + now.getMinutes();
                 const progress = (currentMinutes / minutesInDay) * 100;
               dayProgress.style.width = `${progress}%`;
                  updateNodePositions();
           }
           function updateNodePositions() {
                const minutesInDay = 24 * 60;
                 const containerWidth = dayProgressContainer.offsetWidth;
                 timeNodes.forEach((node, index) => {
                   const nodeTimeMinutes = timeToMinutes(node.time);
                     const nodePosition = (nodeTimeMinutes / minutesInDay) * containerWidth;
                    const nodeElement = document.querySelector(`.time-node-draggable[data-index='${index}']`);
                    if (nodeElement) {
                       nodeElement.style.left = `${nodePosition}px`;
                    }
               });
            }
            function renderSchedule() {
               const now = new Date();
                 const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                 scheduleDateDisplay.textContent = `${year}-${month}-${day}`;
                 scheduleSection.innerHTML = `<h3>日历  <button id="add-time-node-button">+</button></h3>`;
                const addTimeNodeButton = document.getElementById('add-time-node-button');
                addTimeNodeButton.addEventListener('click', () => {
                     addTimeNodeDrawer.classList.add('active');
                    isSettingNewNode = true;
                  dayProgressContainer.addEventListener('mousemove', trackMouseTime);
                    dayProgressContainer.addEventListener('click', confirmNewNode);
                });
                timeNodes.forEach((node, index) => {
                     const nodeItem = document.createElement('div');
                      nodeItem.classList.add('time-node-item');
                    nodeItem.dataset.index = index;
                     nodeItem.innerHTML = `
                          <div class="time-node-detail">
                            <div>${node.name}</div>
                             <div class="reminder-time">提醒时间: ${node.reminder} 分钟</div>
                         </div>
                         <span class="time-node-time">${node.time}</span>
                     `;
                    nodeItem.addEventListener('click', (e) => {
                         if (e.target.classList.contains('time-node-time') && editingNode != index) {
                           editTimeNode(index, nodeItem);
                         } else if (editingNode == index) {
                           stopEditTimeNode(nodeItem)
                       }
                    });
                     scheduleSection.appendChild(nodeItem);
                });
            }
             function editTimeNode(index, nodeItem) {
                 editingNode = index;
                 nodeItem.classList.add('editing');
                const timeNodeTime = nodeItem.querySelector('.time-node-time');
                 const oldTime = timeNodeTime.textContent;
                  timeNodeTime.contentEditable = true;
                timeNodeTime.focus();
               timeNodeTime.addEventListener('blur', stopEditTimeNode);
            }
             function stopEditTimeNode(nodeItem) {
               if (editingNode != null){
                   nodeItem.classList.remove('editing');
                    const timeNodeTime = nodeItem.querySelector('.time-node-time');
                     const newTime = timeNodeTime.textContent;
                    if (newTime) {
                        timeNodes[editingNode].time = newTime;
                       localStorage.setItem('timeNodes', JSON.stringify(timeNodes));
                            updateNodePositions();
                            renderSchedule();
                       }
                     timeNodeTime.contentEditable = false;
                     timeNodeTime.removeEventListener('blur', stopEditTimeNode);
                    editingNode = null;
                }
            }
           function updateNodeDisplay() {
                 const minutesInDay = 24 * 60;
                const containerWidth = dayProgressContainer.offsetWidth;
                const sleepTimeDisplay = document.getElementById('sleep-time-display');
                let nodeDisplay = '';
               timeNodes.forEach((node, index) => {
                     const nodeTimeMinutes = timeToMinutes(node.time);
                     const timeDiff = Math.abs( (now.getHours() * 60 + now.getMinutes()) - nodeTimeMinutes);
                   if (timeDiff < 120) {
                         const timeDiffRatio = Math.min(timeDiff, 120) / 120;
                       const opacity =  1 - timeDiffRatio;
                       nodeDisplay += `
                            <span style="font-size: 0.8vw; opacity: ${opacity}; margin-left: 0.3vw; white-space: nowrap;">${node.time}</span>
                        `;
                   }
               });
                 sleepTimeDisplay.innerHTML = nodeDisplay;
            }
             function renderTimeNodes() {
                 const minutesInDay = 24 * 60;
                   const containerWidth = dayProgressContainer.offsetWidth;
                 scheduleContainer.innerHTML = '';
                   timeNodes.forEach((node, index) => {
                       const startTimeMinutes = timeToMinutes(node.time);
                       const startPosition = (startTimeMinutes / minutesInDay) * containerWidth;
                       const timeNode = document.createElement('div');
                         timeNode.classList.add('time-node-draggable');
                         timeNode.dataset.index = index;
                         timeNode.textContent = node.time;
                       timeNode.style.left = `${startPosition}px`;
                       scheduleContainer.appendChild(timeNode);
                      timeNode.addEventListener('mousedown', (e) => {
                           isDraggingNode = true;
                             draggedNodeElement = e.target;
                            dragNodeStartX = e.clientX;
                            dragNodeStartY = e.clientY;
                             draggedNodeOriginalLeft = parseFloat(window.getComputedStyle(draggedNodeElement).left);
                             draggedNodeOriginalTop = parseFloat(window.getComputedStyle(draggedNodeElement).top);
                            document.addEventListener('mousemove', dragNode);
                           document.addEventListener('mouseup', stopDragNode);
                             e.preventDefault();
                        });
                        timeNode.addEventListener('mouseenter', (e) => {
                             const time = timeNodes[index].time;
                           timeNode.textContent = `${time} ${timeNodes[index].name}`;
                        });
                       timeNode.addEventListener('mouseleave', (e) => {
                            timeNode.textContent = timeNodes[index].time;
                       });
                  });
             }
           function dragNode(e) {
                if (!isDraggingNode) return;
                 const rect = dayProgressContainer.getBoundingClientRect();
                 const deltaX = e.clientX - dragNodeStartX;
                  const newLeft = draggedNodeOriginalLeft + deltaX;
                   let percentage = newLeft / rect.width;
                    let newSleepMinutes =  Math.round(percentage * 24 * 60);
                 if (newSleepMinutes < 0) newSleepMinutes = 0;
                 if (newSleepMinutes >= 24 * 60) newSleepMinutes = 24 * 60 -1;
                  newNodeTime = minutesToTime(newSleepMinutes);
                  draggedNodeElement.style.left = `${newLeft}px`;
                 draggedNodeElement.textContent = `${newNodeTime} ${timeNodes[draggedNodeElement.dataset.index].name}`;
                 updateNodePositions();
           }
            function stopDragNode() {
                if (!isDraggingNode) return;
                isDraggingNode = false;
                 if (newNodeTime) {
                     timeNodes[draggedNodeElement.dataset.index].time = newNodeTime;
                     localStorage.setItem('timeNodes', JSON.stringify(timeNodes));
                    draggedNodeElement.textContent = newNodeTime;
                     updateNodeDisplay();
                      renderSchedule();
                }
                 newNodeTime = '';
               document.removeEventListener('mousemove', dragNode);
                 document.removeEventListener('mouseup', stopDragNode);
           }
            function timeToMinutes(timeString) {
                 const [hours, minutes] = timeString.split(':').map(Number);
                 return hours * 60 + minutes;
           }
           function minutesToTime(totalMinutes) {
                 const hours = String(Math.floor(totalMinutes / 60)).padStart(2, '0');
                 const minutes = String(totalMinutes % 60).padStart(2, '0');
                 return `${hours}:${minutes}`;
           }
           function startFocusTimer() {
                 isFocusing = true;
                isPaused = false;
                isOvertime = false;
                 baseBreakDuration = parseInt(breakDurationInput.value, 10) * 60 * 1000;
                 const focusTime = parseInt(focusDurationInput.value, 10) * 60;
               totalFocusTime = focusTime;
                remainingTime = focusTime;
                 focusStartTime = Date.now();
                startStopButton.textContent = '停止';
                startStopButton.classList.add('running');
                controlsContainer.classList.remove('hidden');
                 focusSettingsDetailed.style.display = 'none';
               updateTimerDisplay();
                focusInterval = setInterval(updateTimerDisplay, 100);
                updateProgressBar();
               focusSettingsSummary.classList.add('locked');
                settingsLocked = true;
           }
           function stopTimer() {
                 clearInterval(focusInterval);
                 clearInterval(breakInterval);
                isFocusing = false;
                isPaused = false;
                 isOvertime = false;
                 startStopButton.textContent = '开始/折叠';
                 startStopButton.classList.remove('running');
                 controlsContainer.classList.add('hidden');
                 focusSettingsSummary.classList.remove('locked');
                 settingsLocked = false;
                 updateProgressBar();
            }
            function pauseTimer() {
                if (isFocusing && !isPaused) {
                    clearInterval(focusInterval);
                    clearInterval(breakInterval);
                     isPaused = true;
                     pauseButton.textContent = '继续';
                    pauseStartTime = Date.now();
               } else if (isFocusing && isPaused) {
                     isPaused = false;
                    pauseButton.textContent = '暂停';
                    focusStartTime = focusStartTime + (Date.now() - pauseStartTime);
                    focusInterval = setInterval(updateTimerDisplay, 100);
                } else if (!isFocusing && remainingBreakTime > 0 && isPaused) {
                    isPaused = false;
                    breakStartTime = breakStartTime + (Date.now() - pauseStartTime);
                    breakInterval = setInterval(updateTimerDisplay, 100);
               }
            }
            function resetTimer() {
                stopTimer();
               remainingTime = parseInt(focusDurationInput.value, 10) * 60;
                 updateTimerDisplay();
                updateProgressBar();
           }
           function updateTimerDisplay() {
                if (isFocusing && !isPaused) {
                    const elapsedMilliseconds = Date.now() - focusStartTime;
                    remainingTime = totalFocusTime - Math.floor(elapsedMilliseconds / 1000);
                    if (remainingTime <= 0) {
                        isOvertime = true;
                   }
                   let displaySeconds = Math.abs(remainingTime);
                   const minutes = String(Math.floor(displaySeconds / 60)).padStart(2, '0');
                    const seconds = String(displaySeconds % 60).padStart(2, '0');
                    timerDisplay.textContent = isOvertime ? `-${minutes}:${seconds}` : `${minutes}:${seconds}`;
                   updateProgressBar();
               } else if (!isFocusing && remainingBreakTime > 0 && !isPaused) {
                    const elapsedBreakMilliseconds = Date.now() - breakStartTime;
                    const displayedBreakSeconds = Math.ceil(remainingBreakTime / 1000 - elapsedBreakMilliseconds / 1000);
                     if (displayedBreakSeconds <= 0) {
                        clearInterval(breakInterval);
                         timerDisplay.textContent = '00:00';
                       progressBar.style.width = '0%';
                        return;
                   }
                   const minutes = String(Math.floor(displayedBreakSeconds / 60)).padStart(2, '0');
                     const seconds = String(displayedBreakSeconds % 60).padStart(2, '0');
                     timerDisplay.textContent = `${minutes}:${seconds}`;
                    updateProgressBar();
                }
            }
            function updateProgressBar() {
                 if (isFocusing) {
                    const elapsedMilliseconds = Date.now() - focusStartTime;
                    let progress;
                    if (!isOvertime) {
                         progress = Math.min(1, elapsedMilliseconds / (totalFocusTime * 1000)) * 100;
                        progressBar.classList.remove('overtime');
                         progressBar.style.justifyContent = 'flex-start';
                        progressBar.style.width = `${progress}%`;
                    } else {
                        const overtimeMilliseconds = Date.now() - (focusStartTime + totalFocusTime * 1000);
                        const overtimeRatio = overtimeMilliseconds / (totalFocusTime * 1000);
                        const easedOvertimeProgress = overtimeRatio / (overtimeRatio + 1) * 100;
                      progressBar.classList.add('overtime');
                         progressBar.style.justifyContent = 'flex-end';
                        progressBar.style.width = `${easedOvertimeProgress}%`;
                   }
               }  else if (!isFocusing && remainingBreakTime > 0) {
                     const elapsedBreakMilliseconds = Date.now() - breakStartTime;
                    const progress = Math.min(1, elapsedBreakMilliseconds / totalBreakTime) * 100;
                      progressBar.classList.remove('overtime');
                    progressBar.style.justifyContent = 'flex-start';
                    progressBar.style.width = `${progress}%`;
                } else {
                    progressBar.style.width = '0%';
                   progressBar.classList.remove('overtime');
                     progressBar.style.justifyContent = 'flex-start';
                }
           }
            startStopButton.addEventListener('click', () => {
                if (isFocusing) {
                   stopTimer();
                } else {
                  startFocusTimer();
                }
           });
          pauseButton.addEventListener('click', () => {
                pauseTimer();
           });
            clearButton.addEventListener('click', () => {
                resetTimer();
            });
            function startBreakTimer(earlyBreak = false) {
                 clearInterval(focusInterval);
                isFocusing = false;
                isPaused = false;
                focusSettingsSummary.classList.remove('locked');
                settingsLocked = false;
                 let breakDuration = baseBreakDuration;
                 let overtimeMinutes = 0;
                 if (earlyBreak && remainingTime > 0) {
                     breakDuration = Math.max(0, baseBreakDuration - (totalFocusTime - remainingTime) * 1000);
                 } else if (isOvertime) {
                     const overtimeMilliseconds = Date.now() - (focusStartTime + totalFocusTime * 1000);
                      overtimeMinutes = Math.ceil(overtimeMilliseconds / (60 * 1000));
                      breakDuration = baseBreakDuration * (quadraticA * overtimeMinutes * overtimeMinutes + quadraticB * overtimeMinutes + quadraticC);
                 }
                totalBreakTime = breakDuration;
                 remainingBreakTime = breakDuration;
               breakStartTime = Date.now();
               startStopButton.textContent = '开始/折叠';
               startStopButton.classList.remove('running');
                controlsContainer.classList.add('hidden');
                updateTimerDisplay();
                 updateProgressBar();
                breakInterval = setInterval(updateTimerDisplay, 100);
            }
             breakButton.addEventListener('click', () => {
                if (isFocusing) {
                    startBreakTimer(true);
                 } else if (remainingBreakTime > 0) {
                    clearInterval(breakInterval);
                     remainingBreakTime = 0;
                    timerDisplay.textContent = '00:00';
                     progressBar.style.width = '0%';
                    focusSettingsSummary.classList.remove('locked');
                    settingsLocked = false;
                }
            });
            // ----- 睡眠时间设置 -----
            function displaySleepTime() {
                if (timeNodes.length > 0) {
                     const [hours, minutes] = timeNodes[0].time.split(':');
                  sleepHoursInput.value = parseInt(hours);
                     sleepMinutesInput.value = parseInt(minutes);
                    sleepTimeInput.value = timeNodes[0].time;
                }
            }
             dayProgressContainer.addEventListener('click', () => {
                if(!settingsLocked){
                   sleepTimeSettings.classList.toggle('hidden');
                    if (!sleepTimeSettings.classList.contains('hidden')) {
                        displaySleepTime();
                   }
               }
            });
            sleepTimeConfirmButton.addEventListener('click', () => {
                sleepTimeSettings.classList.add('hidden');
            });
            focusSettingsSummary.addEventListener('click', () => {
                 if (!settingsLocked) {
                    focusSettingsSummary.style.display = 'none';
                     focusSettingsDetailed.style.display = 'flex';
                } else if (focusSettingsDetailed.style.display != 'none' ) {
                   focusSettingsDetailed.style.display = 'none';
               }
            });
            // ----- 专注时间设置 -----
           focusDurationSlider.addEventListener('input', () => {
                 focusDurationInput.value = focusDurationSlider.value;
                focusDurationDisplay.textContent = focusDurationSlider.value;
            });
           focusDurationInput.addEventListener('change', () => {
                focusDurationSlider.value = focusDurationInput.value;
                focusDurationDisplay.textContent = focusDurationInput.value;
            });
            breakDurationSlider.addEventListener('input', () => {
               breakDurationInput.value = breakDurationSlider.value;
                breakDurationDisplay.textContent = breakDurationSlider.value;
            });
            breakDurationInput.addEventListener('change', () => {
                 breakDurationSlider.value = breakDurationInput.value;
                 breakDurationDisplay.textContent = breakDurationInput.value;
            });
             breakMultiplierSlider.addEventListener('input', () => {
                 breakMultiplierInput.value = breakMultiplierSlider.value;
               breakTimeMultiplier = parseFloat(breakMultiplierSlider.value);
                localStorage.setItem('breakTimeMultiplier', breakTimeMultiplier);
            });
             breakMultiplierInput.addEventListener('change', () => {
                    let value = parseFloat(breakMultiplierInput.value);
                   if (value < 0.1) {
                        value = 0.1;
                        breakMultiplierInput.value = 0.1;
                    }
                    if (value > 5) {
                         value = 5;
                        breakMultiplierInput.value = 5;
                   }
                    breakMultiplierSlider.value = value;
                     breakTimeMultiplier = value;
                    localStorage.setItem('breakTimeMultiplier', breakTimeMultiplier);
                });
            transitionMultiplierSlider.addEventListener('input', () => {
                transitionMultiplierInput.value = transitionMultiplierSlider.value;
                 transitionMultiplier = parseInt(transitionMultiplierSlider.value);
                 localStorage.setItem('transitionMultiplier', transitionMultiplier);
           });
            transitionMultiplierInput.addEventListener('change', () => {
                  let value = parseInt(transitionMultiplierInput.value);
                  if (value < 1) {
                        value = 1;
                        transitionMultiplierInput.value = 1;
                  }
                    if (value > 10) {
                        value = 10;
                         transitionMultiplierInput.value = 10;
                    }
                 transitionMultiplierSlider.value = value;
                 transitionMultiplier = value;
                 localStorage.setItem('transitionMultiplier', transitionMultiplier);
            });
            quadraticAInput.addEventListener('change', () => {
               quadraticA = parseFloat(quadraticAInput.value);
                localStorage.setItem('quadraticA', quadraticA);
            });
            quadraticBInput.addEventListener('change', () => {
               quadraticB = parseFloat(quadraticBInput.value);
                localStorage.setItem('quadraticB', quadraticB);
           });
             quadraticCInput.addEventListener('change', () => {
               quadraticC = parseFloat(quadraticCInput.value);
                 localStorage.setItem('quadraticC', quadraticC);
             });
             transitionMultiplierInput.value = transitionMultiplier;
            transitionMultiplierSlider.value = transitionMultiplier;
            breakMultiplierInput.value = breakTimeMultiplier;
            breakMultiplierSlider.value = breakTimeMultiplier;
            quadraticAInput.value = quadraticA;
            quadraticBInput.value = quadraticB;
           quadraticCInput.value = quadraticC;
             renderTimeNodes();
            renderSchedule();
           updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            updateDayProgress();
            displaySleepTime();
            focusDurationDisplay.textContent = focusDurationInput.value;
            breakDurationDisplay.textContent = breakDurationInput.value;
           pauseButton.textContent = '暂停';
        });
    </script>
</body>
</html>
