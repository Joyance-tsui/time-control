<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级时间管理助手</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 80%;
            max-width: 800px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        header {
            background-color: #eee;
            padding: 20px;
            border-bottom: 1px solid #ccc;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #555;
        }

        /* Timeline Styles */
        .timeline-container {
            position: relative;
            height: 30px;
            background-color: #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .timeline-bar {
            height: 100%;
            width: 100%;
            background-color: #bbb;
            border-radius: 5px;
            position: relative;
        }

        .current-time-indicator {
            position: absolute;
            top: -5px;
            width: 2px;
            height: calc(100% + 10px);
            background-color: #333;
            left: 50%;
            transform: translateX(-50%);
        }

        .time-labels {
            position: absolute;
            top: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            color: #777;
            font-size: 0.8em;
        }

        .time-block {
            position: absolute;
            top: 0;
            height: 100%;
            opacity: 0.6;
            border-radius: 5px;
            cursor: grab;
        }

        .time-block:active {
            cursor: grabbing;
        }

        .sleep-time {
            background-color: #ffaaaa !important;
        }

        /* Settings Styles */
        .settings {
            padding: 20px;
            border-bottom: 1px solid #ccc;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .form-group label {
            width: 150px;
            display: inline-block;
            margin-right: 10px;
            text-align: right;
        }

        .form-group input[type="time"],
        .form-group input[type="text"],
        .form-group input[type="number"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 160px);
        }

        #custom-time-blocks {
            margin-top: 20px;
        }

        #time-blocks-container {
            margin-top: 10px;
        }

        .custom-time-block-form {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .custom-time-block-form input[type="time"],
        .custom-time-block-form input[type="color"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .settings button {
            background-color: #555;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            display: block;
            margin: 20px auto 0;
        }

        /* Task Management Styles */
        .task-management {
            padding: 20px;
            border-bottom: 1px solid #ccc;
        }

        .add-task {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #new-task {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #task-list {
            list-style: none;
            padding: 0;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
        }

        .task-item button {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            color: #888;
        }

        /* Focus Timer Styles */
        .focus-timer {
            padding: 20px;
        }

        .timer-controls {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-group label {
            margin-bottom: 5px;
            color: #777;
        }

        .input-group input[type="number"] {
            width: 60px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
        }

        .task-selection {
            margin-bottom: 20px;
            text-align: center;
        }

        .task-selection select {
            padding: 8px;
            border-radius: 4px;
        }

        .timer-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .progress-bar-container {
            background-color: #ddd;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            background-color: #bbb;
            height: 100%;
            position: relative;
        }

        .progress {
            background-color: #007bff;
            height: 100%;
            width: 0;
            transition: width 0.3s linear;
        }

        .overtime-progress {
            background-color: #ff4d4d;
            height: 100%;
            width: 0;
            position: absolute;
            top: 0;
            left: 0;
        }

        .timer-text {
            font-size: 2em;
            color: #333;
        }

        .timer-buttons {
            text-align: center;
        }

        .timer-buttons button {
            background-color: #555;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 10px;
        }

        .timer-buttons button:hover {
            background-color: #777;
        }

        .task-progress {
            text-align: center;
            color: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="timeline-container">
                <div class="timeline-bar">
                    <div class="current-time-indicator"></div>
                </div>
                <div class="time-labels"></div>
            </div>
        </header>

        <section class="settings">
            <h2>每日时间设置</h2>
            <form id="time-settings">
                <div class="form-group">
                    <label for="wake-up-time">起床时间:</label>
                    <input type="time" id="wake-up-time" value="07:00" required>
                </div>
                <div class="form-group">
                    <label for="sleep-time">最晚睡眠时间:</label>
                    <input type="time" id="sleep-time" value="23:00" required>
                </div>
                <div id="custom-time-blocks">
                    <h3>自定义时间段</h3>
                    <button type="button" id="add-time-block">添加时间段</button>
                    <div id="time-blocks-container">
                        <!-- 自定义时间段将在这里生成 -->
                    </div>
                </div>
                <button type="submit">保存设置</button>
            </form>
        </section>

        <section class="task-management">
            <h2>任务管理</h2>
            <div class="add-task">
                <input type="text" id="new-task" placeholder="添加新任务">
                <button id="add-task-button">添加</button>
            </div>
            <ul id="task-list">
                <!-- 任务列表将在这里生成 -->
            </ul>
        </section>

        <section class="focus-timer">
            <h2>专注时间钟</h2>
            <div class="timer-controls">
                <div class="input-group">
                    <label for="focus-duration">专注时间 (分钟):</label>
                    <input type="number" id="focus-duration" value="25">
                </div>
                <div class="input-group">
                    <label for="break-duration">休息时间 (分钟):</label>
                    <input type="number" id="break-duration" value="5">
                </div>
                <div class="input-group">
                    <label for="pomodoros-per-task">番茄次数:</label>
                    <input type="number" id="pomodoros-per-task" value="4">
                </div>
            </div>
            <div class="task-selection">
                <label for="selected-task">选择任务:</label>
                <select id="selected-task">
                    <option value="">-- 请选择任务 --</option>
                </select>
            </div>
            <div class="timer-display">
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress"></div>
                        <div class="overtime-progress"></div>
                    </div>
                </div>
                <div class="timer-text">00:00</div>
            </div>
            <div class="timer-buttons">
                <button id="start-stop-button">开始</button>
                <button id="reset-button">重置</button>
            </div>
            <div class="task-progress">
                <span>已完成番茄: <span id="completed-pomodoros">0</span> / <span id="total-pomodoros">0</span></span>
            </div>
        </section>
    </div>

    <audio id="notification-sound" preload="auto">
        <source src="notification.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Cookie 工具函数 ---
            function setCookie(name, value, days) {
                const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toUTCString();
                document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
            }

            function getCookie(name) {
                const cookies = document.cookie.split('; ').find(cookie => cookie.startsWith(name + '='));
                return cookies ? decodeURIComponent(cookies.split('=')[1]) : null;
            }

            function deleteCookie(name) {
                document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
            }

            // --- 声音提醒 ---
            const notificationSound = document.getElementById('notification-sound');
            function playNotificationSound() {
                notificationSound.play();
            }

            // --- 时间轴部分 ---
            const timelineBar = document.querySelector('.timeline-bar');
            const currentTimeIndicator = document.querySelector('.current-time-indicator');
            const timeLabels = document.querySelector('.time-labels');
            const timeSettingsForm = document.getElementById('time-settings');
            const wakeUpTimeInput = document.getElementById('wake-up-time');
            const sleepTimeInput = document.getElementById('sleep-time');
            const timeBlocksContainer = document.getElementById('time-blocks-container');
            const addTimeBlockButton = document.getElementById('add-time-block');

            let wakeUpTime, sleepTime, customTimeBlocks = [];

            function updateTimeline() {
                const now = new Date();
                const startOfDay = new Date(now);
                startOfDay.setHours(0, 0, 0, 0);
                const elapsedMilliseconds = now - startOfDay;
                const totalMillisecondsInDay = 24 * 60 * 60 * 1000;
                const position = (elapsedMilliseconds / totalMillisecondsInDay) * 100;
                currentTimeIndicator.style.left = `${position}%`;

                updateTimeLabels();
                renderTimeBlocks();
            }

            function updateTimeLabels() {
                timeLabels.innerHTML = '';
                for (let i = 0; i <= 24; i += 3) {
                    const label = document.createElement('span');
                    label.textContent = `${i < 10 ? '0' : ''}${i}:00`;
                    const labelPosition = (i / 24) * 100;
                    label.style.left = `calc(${labelPosition}% - ${label.offsetWidth / 2}px)`;
                    timeLabels.appendChild(label);
                }
            }

            function renderTimeBlocks() {
                timelineBar.querySelectorAll('.time-block').forEach(block => block.remove());

                // 睡眠时间
                renderSleepTimeBlock();

                // 自定义时间段
                customTimeBlocks.forEach(blockData => {
                    renderCustomTimeBlock(blockData);
                });
            }

            function renderSleepTimeBlock() {
                const sleepBlock = document.createElement('div');
                sleepBlock.classList.add('time-block', 'sleep-time');
                const [sleepStartPercentage, sleepEndPercentage] = calculateTimeBlockPercentages(wakeUpTime, sleepTime);
                if (sleepStartPercentage !== null && sleepEndPercentage !== null) {
                    sleepBlock.style.left = `${sleepStartPercentage}%`;
                    sleepBlock.style.width = `${sleepEndPercentage - sleepStartPercentage}%`;
                    timelineBar.appendChild(sleepBlock);
                }
            }

            function renderCustomTimeBlock(blockData) {
                const block = document.createElement('div');
                block.classList.add('time-block');
                block.style.backgroundColor = blockData.color;
                const [startPercentage, endPercentage] = calculateTimeBlockPercentages(blockData.startTime, blockData.endTime);
                if (startPercentage !== null && endPercentage !== null) {
                    block.style.left = `${startPercentage}%`;
                    block.style.width = `${endPercentage - startPercentage}%`;
                    block.draggable = true; // 使其可拖动
                    block.dataset.id = blockData.id; // 存储 ID 以便识别
                    timelineBar.appendChild(block);

                    // 添加拖拽事件监听器
                    block.addEventListener('dragstart', handleDragStart);
                    block.addEventListener('dragend', handleDragEnd);
                }
            }

            function calculateTimeBlockPercentages(startTimeStr, endTimeStr) {
                const [startHour, startMinute] = startTimeStr.split(':').map(Number);
                const [endHour, endMinute] = endTimeStr.split(':').map(Number);

                const startTotalMinutes = startHour * 60 + startMinute;
                const endTotalMinutes = endHour * 60 + endMinute;

                let startPercentage = (startTotalMinutes / (24 * 60)) * 100;
                let endPercentage = (endTotalMinutes / (24 * 60)) * 100;

                if (endTotalMinutes <= startTotalMinutes) {
                    endPercentage += 100; // 处理跨午夜的情况
                }

                return [startPercentage, endPercentage];
            }

            function loadSettings() {
                const savedWakeUpTime = getCookie('wakeUpTime');
                const savedSleepTime = getCookie('sleepTime');
                const savedCustomTimeBlocks = getCookie('customTimeBlocks');

                if (savedWakeUpTime) wakeUpTimeInput.value = savedWakeUpTime;
                if (savedSleepTime) sleepTimeInput.value = savedSleepTime;
                if (savedCustomTimeBlocks) {
                    customTimeBlocks = JSON.parse(savedCustomTimeBlocks);
                    renderCustomTimeBlockForms();
                }

                wakeUpTime = wakeUpTimeInput.value;
                sleepTime = sleepTimeInput.value;
                renderTimeBlocks();
            }

            function saveSettings() {
                setCookie('wakeUpTime', wakeUpTimeInput.value, 30);
                setCookie('sleepTime', sleepTimeInput.value, 30);
                setCookie('customTimeBlocks', JSON.stringify(customTimeBlocks), 30);
                renderTimeBlocks();
            }

            timeSettingsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                wakeUpTime = wakeUpTimeInput.value;
                sleepTime = sleepTimeInput.value;
                saveSettings();
            });

            addTimeBlockButton.addEventListener('click', () => {
                const newBlock = {
                    id: Date.now(),
                    startTime: '09:00',
                    endTime: '10:00',
                    color: '#aaffaa'
                };
                customTimeBlocks.push(newBlock);
                renderCustomTimeBlockForms();
                saveSettings();
            });

            function renderCustomTimeBlockForms() {
                timeBlocksContainer.innerHTML = '';
                customTimeBlocks.forEach(block => {
                    const form = document.createElement('div');
                    form.classList.add('custom-time-block-form');
                    form.innerHTML = `
                        <input type="time" value="${block.startTime}" data-id="${block.id}" data-field="startTime">
                        <input type="time" value="${block.endTime}" data-id="${block.id}" data-field="endTime">
                        <input type="color" value="${block.color}" data-id="${block.id}" data-field="color">
                        <button type="button" class="delete-time-block" data-id="${block.id}">删除</button>
                    `;
                    timeBlocksContainer.appendChild(form);
                });
            }

            timeBlocksContainer.addEventListener('change', (e) => {
                if (e.target.matches('input[type="time"], input[type="color"]')) {
                    const blockId = parseInt(e.target.dataset.id);
                    const field = e.target.dataset.field;
                    const value = e.target.value;
                    const block = customTimeBlocks.find(b => b.id === blockId);
                    if (block) {
                        block[field] = value;
                        saveSettings();
                    }
                }
            });

            timeBlocksContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-time-block')) {
                    const blockIdToDelete = parseInt(e.target.dataset.id);
                    customTimeBlocks = customTimeBlocks.filter(block => block.id !== blockIdToDelete);
                    renderCustomTimeBlockForms();
                    saveSettings();
                }
            });

            // --- 拖拽调整时间段 ---
            let draggedBlock = null;
            let dragStartOffset = 0;

            function handleDragStart(event) {
                draggedBlock = event.target;
                dragStartOffset = event.clientX - draggedBlock.offsetLeft;
            }

            function handleDragEnd(event) {
                draggedBlock = null;
            }

            timelineBar.addEventListener('dragover', (event) => {
                event.preventDefault();
            });

            timelineBar.addEventListener('drop', (event) => {
                event.preventDefault();
                if (draggedBlock) {
                    const timelineWidth = timelineBar.offsetWidth;
                    const newLeft = event.clientX - timelineBar.offsetLeft - dragStartOffset;
                    const startPercentage = Math.max(0, Math.min(100, (newLeft / timelineWidth) * 100));

                    const blockId = parseInt(draggedBlock.dataset.id);
                    const blockData = customTimeBlocks.find(b => b.id === blockId);
                    if (blockData) {
                        const durationPercentage = parseFloat(draggedBlock.style.width);
                        const endPercentage = startPercentage + durationPercentage;

                        const startTimeMinutes = Math.floor((startPercentage / 100) * 24 * 60);
                        const endTimeMinutes = Math.floor((endPercentage / 100) * 24 * 60);

                        const newStartHour = String(Math.floor(startTimeMinutes / 60)).padStart(2, '0');
                        const newStartMinute = String(startTimeMinutes % 60).padStart(2, '0');
                        const newEndHour = String(Math.floor(endTimeMinutes / 60) % 24).padStart(2, '0');
                        const newEndMinute = String(endTimeMinutes % 60).padStart(2, '0');

                        blockData.startTime = `${newStartHour}:${newStartMinute}`;
                        blockData.endTime = `${newEndHour}:${newEndMinute}`;
                        renderCustomTimeBlockForms();
                        saveSettings();
                    }
                    draggedBlock = null;
                }
            });

            // --- 任务管理 ---
            const newTaskInput = document.getElementById('new-task');
            const addTaskButton = document.getElementById('add-task-button');
            const taskList = document.getElementById('task-list');
            const selectedTaskSelect = document.getElementById('selected-task');
            let tasks = [];

            function loadTasks() {
                const savedTasks = getCookie('tasks');
                if (savedTasks) {
                    tasks = JSON.parse(savedTasks);
                    renderTasks();
                }
            }

            function saveTasks() {
                setCookie('tasks', JSON.stringify(tasks), 30);
                renderTasks();
            }

            function renderTasks() {
                taskList.innerHTML = '';
                selectedTaskSelect.innerHTML = '<option value="">-- 请选择任务 --</option>';
                tasks.forEach(task => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('task-item');
                    listItem.innerHTML = `
                        <span>${task.name}</span>
                        <div>
                            <button onclick="startTaskPomodoro(${task.id})">开始番茄</button>
                            <button onclick="deleteTask(${task.id})">删除</button>
                        </div>
                    `;
                    taskList.appendChild(listItem);

                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = task.name;
                    selectedTaskSelect.appendChild(option);
                });
            }

            window.startTaskPomodoro = function(taskId) {
                selectedTaskSelect.value = taskId;
                resetTimer();
            };

            window.deleteTask = function(taskId) {
                tasks = tasks.filter(task => task.id !== taskId);
                saveTasks();
            };

            addTaskButton.addEventListener('click', () => {
                const taskName = newTaskInput.value.trim();
                if (taskName) {
                    const newTask = { id: Date.now(), name: taskName, pomodorosCompleted: 0 };
                    tasks.push(newTask);
                    saveTasks();
                    newTaskInput.value = '';
                }
            });

            // --- 专注时间钟部分 ---
            const focusDurationInput = document.getElementById('focus-duration');
            const breakDurationInput = document.getElementById('break-duration');
            const startStopButton = document.getElementById('start-stop-button');
            const resetButton = document.getElementById('reset-button');
            const timerText = document.querySelector('.timer-text');
            const progressBar = document.querySelector('.progress');
            const overtimeProgress = document.querySelector('.overtime-progress');
            const progressBarContainer = document.querySelector('.progress-bar-container');
            const pomodorosPerTaskInput = document.getElementById('pomodoros-per-task');
            const completedPomodorosSpan = document.getElementById('completed-pomodoros');
            const totalPomodorosSpan = document.getElementById('total-pomodoros');

            let focusTime = parseInt(focusDurationInput.value, 10) * 60;
            let breakTime = parseInt(breakDurationInput.value, 10) * 60;
            let timeLeft;
            let isRunning = false;
            let isFocusing = true;
            let timerInterval;
            let currentTask = null;

            function updateTimerDisplay() {
                const minutes = Math.floor(Math.abs(timeLeft) / 60);
                const seconds = Math.abs(timeLeft) % 60;
                timerText.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            function updateProgressBar() {
                let percentage;
                if (timeLeft >= 0) {
                    percentage = (1 - timeLeft / (isFocusing ? focusTime : breakTime)) * 100;
                    progressBar.style.width = `${percentage}%`;
                    overtimeProgress.style.width = '0%';
                } else {
                    percentage = Math.abs(timeLeft) / (isFocusing ? focusTime : breakTime) * 100;
                    progressBar.style.width = '100%';
                    overtimeProgress.style.width = `${percentage}%`;
                }
            }

            function startTimer() {
                isRunning = true;
                startStopButton.textContent = '停止';
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    updateProgressBar();

                    if (timeLeft < 0) {
                        progressBarContainer.style.backgroundColor = '#ffdddd'; // 超时背景色
                    }

                    if (timeLeft <= -5) { // 超时 5 秒后改变颜色
                        overtimeProgress.style.backgroundColor = '#ff4d4d';
                    }

                    if (timeLeft < (isFocusing ? -focusTime : -breakTime)) {
                        clearInterval(timerInterval);
                        playNotificationSound();
                        if (isFocusing) {
                            if (currentTask) {
                                currentTask.pomodorosCompleted = (currentTask.pomodorosCompleted || 0) + 1;
                                saveTasks();
                                updateTaskProgressDisplay();
                            }
                        }
                        isFocusing = !isFocusing;
                        timeLeft = isFocusing ? focusTime : breakTime;
                        progressBarContainer.style.backgroundColor = '#ddd'; // 恢复正常背景色
                        overtimeProgress.style.backgroundColor = '#ff4d4d'; // 恢复超时颜色
                        if (selectedTaskSelect.value) {
                             startTimer();
                        } else {
                            stopTimer();
                        }
                    }
                }, 1000);
            }

            function stopTimer() {
                isRunning = false;
                startStopButton.textContent = '开始';
                clearInterval(timerInterval);
            }

            function resetTimer() {
                stopTimer();
                isFocusing = true;
                timeLeft = focusTime;
                updateTimerDisplay();
                updateProgressBar();
                progressBarContainer.style.backgroundColor = '#ddd';
                overtimeProgress.style.width = '0%';
                updateTaskProgressDisplay();
            }

            function updateTaskProgressDisplay() {
                const selectedTaskId = parseInt(selectedTaskSelect.value);
                currentTask = tasks.find(task => task.id === selectedTaskId);
                const totalPomodoros = parseInt(pomodorosPerTaskInput.value, 10);
                totalPomodorosSpan.textContent = totalPomodoros;
                if (currentTask) {
                    completedPomodorosSpan.textContent = currentTask.pomodorosCompleted || 0;
                } else {
                    completedPomodorosSpan.textContent = '0';
                }
            }

            startStopButton.addEventListener('click', () => {
                const selectedTaskId = parseInt(selectedTaskSelect.value);
                if (selectedTaskId && !isRunning) {
                    currentTask = tasks.find(task => task.id === selectedTaskId);
                    startTimer();
                } else {
                    stopTimer();
                }
            });

            resetButton.addEventListener('click', resetTimer);

            focusDurationInput.addEventListener('change', () => {
                focusTime = parseInt(focusDurationInput.value, 10) * 60;
                if (!isRunning) {
                    resetTimer();
                }
            });

            breakDurationInput.addEventListener('change', () => {
                breakTime = parseInt(breakDurationInput.value, 10) * 60;
                if (!isRunning) {
                    resetTimer();
                }
            });

            pomodorosPerTaskInput.addEventListener('change', updateTaskProgressDisplay);

            selectedTaskSelect.addEventListener('change', () => {
                resetTimer();
                updateTaskProgressDisplay();
            });

            // 初始化
            loadSettings();
            loadTasks();
            updateTimeline();
            setInterval(updateTimeline, 60000); // 每分钟更新时间轴
            resetTimer();
        });
    </script>
</body>
</html>
